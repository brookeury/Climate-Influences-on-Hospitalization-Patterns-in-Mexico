---
title: "modeling_3_16"
author: "Brooke Ury"
date: "2025-03-16"
output: pdf_document
---

```{r}
library(stringr)
library(ISOweek)
library(lubridate)
library(dplyr)
library(doBy)
library(dplyr)
library(mgcv)
library(ggplot2)
library(lfe)
library(nortest)
library(lfe)
```

#load hospitalization data
```{r}
base_path <- "/csv/"
years <- 2000:2013
datasets <- list()

# Loop through each year and read the corresponding CSV file
for (i in 1:length(years)) {
  file_path <- paste0(base_path, "SAEH_BD_", years[i], ".csv")
  datasets[[i]] <- read.csv(file_path)
}
```

#load climate data
```{r}
rain_df <- read.csv("/climate_data/precipitation_data.csv")
temp_df <- read.csv("/climate_data/temperature_data.csv")
```

Prepare datasets for modeling by aggregating data and adding columns
```{r}
datasets_ICD <- datasets
```

#group by common date, ICD code, state
```{r}
for (i in seq_along(datasets_ICD)) {   
  # Update the dataset with new columns and filter
  datasets_ICD[[i]] <- datasets_ICD[[i]] %>% 
    group_by(ENTIDAD, date, AFECPRIN) %>%
    summarise(count = sum(count)
    )
}
```

#make week, year, month columns
```{r}
for (i in seq_along(datasets_ICD)) {   
  # Update the dataset with new columns and filter
  datasets_ICD[[i]] <- datasets_ICD[[i]] %>% 
    mutate(
      week = week(date),
      year = year(date),
      
      #month
      week_padded = sprintf("%02d", week),
      start_date1 = (paste("W", week_padded, sep = "")),
      start_date = ISOweek2date(paste(year, start_date1, 1, sep = "-")),
      month = month(start_date)
    ) %>%
    dplyr::select(-start_date, -start_date1, -week_padded
    )
}
```

#remove weeks 1,52, and 53, states that aren't 1-32 
```{r}
for (i in seq_along(datasets_ICD)) {   
  # Update the dataset with new columns and filter
  datasets_ICD[[i]] <- datasets_ICD[[i]] %>% 
    filter(
      !(week %in% c(1, 52, 53)), ENTIDAD >= 1 & ENTIDAD <= 32
    )
}
```

#combine the datasets together
```{r}
df_combined <- bind_rows(datasets_ICD)
```

#Aggregate at the week level (to aggregate across datasets if the same date is in mutliple datasets)
```{r}
df_combined <- df_combined %>% 
    group_by(ENTIDAD, AFECPRIN, week, year, month) %>%
    summarise(total_count = sum(count)
    )
```

#make ICD category
```{r}
df_combined  <- df_combined %>% 
  mutate(
      ICDcategory = tolower(substr(AFECPRIN, 1, 1)),  # Extract the letter part
      ICDcode = substr(AFECPRIN, 2, 4),               # Extract the 3-digit part
      icdcode_first_two = substr(ICDcode, 1, 2)       # get the first two digits of the ICD code
    )
```


#add temp and precip (no need to add temp and precip bins)

#create rain df
```{r}
rain_df$date <- as.Date(rain_df$date)

# Create a 'month' column from the 'date' column
rain_df <- rain_df %>%
  mutate(week = week(date))

# Group by 'year', 'month', and 'state', then calculate the mean of 'l1_acpcp'
rain_df_avg_weekly_state <- rain_df %>%
  group_by(year, week, state) %>%
  summarise(l1_acpcp_avg = mean(l1_acpcp, na.rm = TRUE)) %>%
  ungroup()
```

#create temp df
```{r}
temp_df$date <- as.Date(temp_df$date)

# Create a 'month' column from the 'date' column
temp_df <- temp_df %>%
  mutate(week = week(date))

temp_df_avg_weekly_state <- temp_df %>%
  group_by(year, week, state) %>%
  summarise(l1_air_avg = mean(l1_air, na.rm = TRUE)) %>%
  ungroup()
```

#rename state
```{r}
df_combined <- df_combined %>% 
    rename(
      state = ENTIDAD
    )
```

#add rain and temp
```{r}
df_combined <- df_combined %>% 
    inner_join(rain_df_avg_weekly_state, by = c("year", "week", "state")) %>%
    inner_join(temp_df_avg_weekly_state, by = c("year", "week", "state"))
```

#add log cases, rename state, temperature, and precipitation
```{r}
df_combined <- df_combined %>% 
    rename(
      precip = l1_acpcp_avg,
      temp = l1_air_avg
    )
```

```{r}
df_combined <- df_combined %>%
    mutate(
      log_cases = log(total_count + 1)
    )
```

#save
```{r}
write.csv(df_combined, file = "/df_ICD_specific_and_climate_all.csv", row.names = FALSE)
```


Iterate through each major ICD category to identify the specific diseases. Then run the linear model

#ICD A
```{r}
datasetsA <- df_combined %>% 
  filter(ICDcategory == "a")
```

```{r}
dfA_test <- datasetsA %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09")
      ~ "Intestinal infectious diseases",
      icdcode_first_two %in% as.character(15:19) ~ "Tuberculosis",
      icdcode_first_two %in% as.character(20:28) ~ "Certain zoonotic bacterial diseases",
      icdcode_first_two %in% as.character(30:49) ~ "Other bacterial diseases",
      icdcode_first_two %in% as.character(50:64) ~ "Infections with a predominantly sexual mode of transmission",
      icdcode_first_two %in% as.character(65:69) ~ "Other spirochetal diseases",
      icdcode_first_two %in% as.character(70:74) ~ "Other diseases caused by chlamydiae",
      icdcode_first_two %in% as.character(75:79) ~ "Rickettsioses",
      icdcode_first_two %in% as.character(80:89) ~ "Viral and prion infections of the central nervous system",
      icdcode_first_two %in% as.character(90:99) ~ "Arthropod-borne viral fevers and viral hemorrhagic fevers",
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
    )
  )
```

#get the counts per disease category
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfA_test %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category
```

#remove disease areas with less than 10,000
```{r}
category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfA_filtered <- dfA_test %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsA <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfA_filtered %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

```

#save
```{r}
write.csv(resultsB, file = "/results_felm_linear/resultsA.csv", row.names = FALSE)
write.csv(dfA_test, file = "/intermediate/dfA.csv", row.names = FALSE)
```


#ICD B
```{r}
datasetsB <- df_combined %>% 
  filter(ICDcategory == "b")
```

```{r}
dfB <- datasetsB %>% 
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "Viral infections characterized by skin and mucous membrane lesions",
      icdcode_first_two %in% as.character(10:11) ~ "Other human herpesviruses",
      icdcode_first_two %in% as.character(15:19) ~ "Viral hepatitis",
      icdcode_first_two %in% as.character(20:24) ~ "Human immunodeficiency virus [HIV] disease",
      icdcode_first_two %in% as.character(25:34) ~ "Other viral diseases",
      icdcode_first_two %in% as.character(35:49) ~ "Mycoses",
      icdcode_first_two %in% as.character(50:64) ~ "Protozoal diseases",
      icdcode_first_two %in% as.character(65:83) ~ "Helminthiases",
      icdcode_first_two %in% as.character(85:89) ~ "Pediculosis, acariasis and other infestations",
      icdcode_first_two %in% as.character(90:94) ~ "Sequelae of infectious and parasitic diseases",
      icdcode_first_two %in% as.character(95:98) ~ "Bacterial and viral infectious agents",
      icdcode_first_two %in% c("99") ~ "Other infectious diseases",
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
    )
  )

```

#get the counts per disease category
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfB%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category
```

#remove disease areas with less than 10,000
```{r}
category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfB <- dfB %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsB <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfB %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

```

#save
```{r}
write.csv(resultsB, file = "/results_felm_linear/resultsB.csv", row.names = FALSE)
write.csv(dfB, file = "/intermediate/dfB.csv", row.names = FALSE)
```


#ICD C
```{r}
datasetsC <- df_combined %>% 
  filter(ICDcategory == "c")

dfC <- datasetsC %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09", 
                               "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", 
                               "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", 
                               "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", 
                               "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", 
                               "50", "51", "52", "53", "54", "55", "56", "57", "58", "59", 
                               "60", "61", "62", "63", "64", "65", "66", "67", "68", "69", 
                               "70", "71", "72", "73", "74", "75", "76", "77", "78", "79", 
                               "80", "81", "82", "83", "84", "85", "86", "87", "88", "89", 
                               "90", "91", "92", "93", "94", "95", "96") ~ "Malignant neoplasms",
      TRUE ~ "Other"  # Everything else is categorized as "Other"
    )
  )
```


#get the counts per disease category, remove disease areas with less than 10,000
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfC%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category
```

```{r}
category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfC <- dfC %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```


#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsC <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfC %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsC, file = "/results_felm_linear/resultsC.csv", row.names = FALSE)
```


#ICD E
```{r}
datasetsE <- df_combined %>% 
  filter(ICDcategory == "e")
```

```{r}
dfE <- datasetsE %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07") ~ "Disorders of thyroid gland",
      icdcode_first_two %in% c("08", "09", "10", "11", "12", "13", "14") ~ "Diabetes mellitus",
      icdcode_first_two %in% as.character(15:16) ~ "Other disorders of glucose regulation and pancreatic internal secretion",
      icdcode_first_two %in% as.character(20:35) ~ "Disorders of other endocrine glands",
      icdcode_first_two %in% c("36") ~ "Intraoperative complications of endocrine system",
      icdcode_first_two %in% as.character(40:46) ~ "Malnutrition",
      icdcode_first_two %in% as.character(50:64) ~ "Other nutritional deficiencies",
      icdcode_first_two %in% as.character(65:68) ~ "Overweight, obesity and other hyperalimentation",
      icdcode_first_two %in% as.character(70:88) ~ "Metabolic disorders",
      icdcode_first_two %in% c("89") ~ "Postprocedural endocrine and metabolic complications and disorders, not elsewhere classified",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)
```

```{r}
write.csv(dfE, file = "/intermediate/dfE.csv", row.names = FALSE)
```

```{r}
dfE_test_08 <- dfE %>%
  filter(icdcode_first_two == "08")

dfE_test_09 <- dfE %>%
  filter(icdcode_first_two == "09")
```


```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfE%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category
```

#get the counts per disease category, remove disease areas with less than 10,000
```{r}

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfE <- dfE %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsE <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfE %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsE, file = "/results_felm_linear/resultsD.csv", row.names = FALSE)
```

 
#ICD D
```{r}
datasetsD <- df_combined %>% 
  filter(ICDcategory == "d")
```

```{r}
dfD <- datasetsD %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "In situ neoplasms",
      #icdcode_first_two %in% c("3A", "3A.8") ~ "Benign neuroendocrine tumors",
      icdcode_first_two %in% as.character(10:36) ~ "Benign neoplasms, except benign neuroendocrine tumors",
      icdcode_first_two %in% as.character(37:48) ~ "Neoplasms of uncertain behavior, polycythemia vera and myelodysplastic syndromes",
      icdcode_first_two %in% c("49") ~ "Neoplasms of unspecified behavior",
      icdcode_first_two %in% as.character(50:53) ~ "Nutritional anemias",
      icdcode_first_two %in% as.character(55:59) ~ "Hemolytic anemias",
      icdcode_first_two %in% as.character(60:64) ~ "Aplastic and other anemias and other bone marrow failure syndromes",
      icdcode_first_two %in% as.character(65:69) ~ "Coagulation defects, purpura and other hemorrhagic conditions",
      icdcode_first_two %in% as.character(70:77) ~ "Other disorders of blood and blood-forming organs",
      icdcode_first_two %in% c("78") ~ "Intraoperative and postprocedural complications of the spleen",
      icdcode_first_two %in% as.character(80:89) ~ "Certain disorders involving the immune mechanism",
  
      TRUE ~ "Benign neuroendocrine tumors"  # If none of the categories match, assign "Other"
    )
)
```

```{r}
write.csv(dfA, file = "/intermediate/dfA.csv", row.names = FALSE)
write.csv(dfB, file = "/intermediate/dfB.csv", row.names = FALSE)
write.csv(dfC, file = "/intermediate/dfC.csv", row.names = FALSE)

#write.csv(dfD, file = "/intermediate/dfD.csv", row.names = FALSE)
```

```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfD%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category
```

#get the counts per disease category, remove disease areas with less than 10,000
```{r}

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfD <- dfD %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsD <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfD %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsD, file = "/results_felm_linear/resultsD.csv", row.names = FALSE)
```


#ICD F
```{r}
datasetsF <- df_combined %>% 
  filter(ICDcategory == "f")
```

```{r}
dfF <- datasetsF %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "Mental disorders due to known physiological conditions",
      icdcode_first_two %in% as.character(10:19) ~ "Mental and behavioral disorders due to psychoactive substance use",
      icdcode_first_two %in% as.character(20:29) ~ "Schizophrenia, schizotypal, delusional, and other non-mood psychotic disorders",
      icdcode_first_two %in% as.character(30:39) ~ "Mood [affective] disorders",
      icdcode_first_two %in% as.character(40:49) ~ "Anxiety, dissociative, stress-related, somatoform and other nonpsychotic mental disorders",
      icdcode_first_two %in% as.character(50:59) ~ "Behavioral syndromes associated with physiological disturbances and physical factors",
      icdcode_first_two %in% as.character(60:69) ~ "Disorders of adult personality and behavior",
      icdcode_first_two %in% as.character(70:79) ~ "Intellectual Disabilities",
      icdcode_first_two %in% as.character(80:89) ~ "Pervasive and specific developmental disorders",
      icdcode_first_two %in% as.character(90:98) ~ "Behavioral and emotional disorders with onset usually occurring in childhood and adolescence",
      icdcode_first_two %in% c("99") ~ "Unspecified mental disorder",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)
```

```{r}
write.csv(dfF, file = "/intermediate/dfF.csv", row.names = FALSE)
```

```{r}
dfF_test_49 <- dfF %>%
  filter(icdcode_first_two == "49")
```

#get the counts per disease category, remove disease areas with less than 10,000
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfF%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfF <- dfF %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsF <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfF %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsF, file = "/results_felm_linear/resultsF.csv", row.names = FALSE)
```


#ICD G
```{r}
datasetsG <- df_combined %>% 
  filter(ICDcategory == "g")
```

```{r}
dfG <- datasetsG %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "Inflammatory diseases of the central nervous system",
      icdcode_first_two %in% as.character(10:14) ~ "Systemic atrophies primarily affecting the central nervous system",
      icdcode_first_two %in% as.character(20:26) ~ "Extrapyramidal and movement disorders",
      icdcode_first_two %in% as.character(30:32) ~ "Other degenerative diseases of the nervous system",
      icdcode_first_two %in% as.character(35:37) ~ "Demyelinating diseases of the central nervous system",
      icdcode_first_two %in% as.character(40:47) ~ "Episodic and paroxysmal disorders",
      icdcode_first_two %in% as.character(50:59) ~ "Nerve, nerve root and plexus disorders",
      icdcode_first_two %in% as.character(60:65) ~ "Polyneuropathies and other disorders of the peripheral nervous system",
      icdcode_first_two %in% as.character(70:73) ~ "Diseases of myoneural junction and muscle",
      icdcode_first_two %in% as.character(80:83) ~ "Cerebral palsy and other paralytic syndromes",
      icdcode_first_two %in% as.character(89:99) ~ "Other disorders of the nervous system",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)
```

```{r}
write.csv(dfG, file = "/intermediate/dfG.csv", row.names = FALSE)
```


#get the counts per disease category, remove disease areas with less than 10,000
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfG%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfF <- dfG %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

#run the linear fixed effects regression model for all specific disease areas
```{r}
# Loop through each disease category in the filtered category_counts
resultsG <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfG %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsG, file = "/results_felm_linear/resultsG.csv", row.names = FALSE)
```


#ICD H
```{r}
datasetsH <- df_combined %>% 
  filter(ICDcategory == "h")

dfH <- datasetsH %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05") ~ "Disorders of eyelid, lacrimal system and orbit",
      icdcode_first_two %in% as.character(10:11) ~ "Disorders of conjunctiva",
      icdcode_first_two %in% as.character(15:22) ~ "Disorders of sclera, cornea, iris and ciliary body",
      icdcode_first_two %in% as.character(25:28) ~ "Disorders of lens",
      icdcode_first_two %in% as.character(30:36) ~ "Disorders of choroid and retina",
      icdcode_first_two %in% as.character(40:42) ~ "Glaucoma",
      icdcode_first_two %in% as.character(43:44) ~ "Disorders of vitreous body and globe",
      icdcode_first_two %in% as.character(46:47) ~ "Disorders of optic nerve and visual pathways",
      icdcode_first_two %in% as.character(49:52) ~ "Disorders of ocular muscles, binocular movement, accommodation and refraction",
      icdcode_first_two %in% as.character(53:54) ~ "Visual disturbances and blindness",
      icdcode_first_two %in% as.character(55:57) ~ "Other disorders of eye and adnexa",
      icdcode_first_two %in% c("59")  ~ "Intraoperative and postprocedural complications and disorders of eye and adnexa, not elsewhere classified",
      icdcode_first_two %in% as.character(60:62) ~ "Diseases of external ear",
      icdcode_first_two %in% as.character(65:75) ~ "Diseases of middle ear and mastoid",
      icdcode_first_two %in% as.character(80:83) ~ "Diseases of inner ear",
      icdcode_first_two %in% as.character(90:94) ~ "Other disorders of ear",
      icdcode_first_two %in% c("95") ~ "Intraoperative and postprocedural complications and disorders of ear and mastoid process, not elsewhere classified",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfH, file = "/intermediate/dfH.csv", row.names = FALSE)
```


#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfH%>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfH <- dfH %>%
  filter(disease_category %in% category_counts_filtered$disease_category)

```

```{r}
# Loop through each disease category in the filtered category_counts
resultsH <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfH %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsH, file = "/results_felm_linear/resultsH.csv", row.names = FALSE)
```

#ICD I
```{r}
datasetsI <- df_combined %>% 
  filter(ICDcategory == "i")
```

```{r}
dfI <- datasetsI %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02") ~ "Acute rheumatic fever",
      icdcode_first_two %in% c("05", "06", "07", "08", "09") ~ "Chronic rheumatic heart diseases",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "1A") ~ "Hypertensive diseases",
      icdcode_first_two %in% as.character(20:25) ~ "Ischemic heart diseases",
      icdcode_first_two %in% as.character(26:28) ~ "Pulmonary heart disease and diseases of pulmonary circulation",
      icdcode_first_two %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "5A") ~ "Other forms of heart disease",
      icdcode_first_two %in% as.character(60:69) ~ "Cerebrovascular diseases",
      icdcode_first_two %in% as.character(70:79) ~ "Diseases of arteries, arterioles and capillaries",
      icdcode_first_two %in% as.character(80:89) ~ "Diseases of veins, lymphatic vessels and lymph nodes, not elsewhere classified",
      icdcode_first_two %in% as.character(95:99) ~ "Other and unspecified disorders of the circulatory system",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
    )
)

write.csv(dfI, file = "/intermediate/dfI.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfI %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfI <- dfI %>%
  filter(disease_category %in% category_counts_filtered$disease_category)

```

#run the model
```{r}
# Loop through each disease category in the filtered category_counts
resultsI <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfI %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsI, file = "/results_felm_linear/resultsI.csv", row.names = FALSE)
```



#ICD J
```{r}
datasetsJ <- df_combined %>% 
  filter(ICDcategory == "j")
```

```{r}
dfJ <- datasetsJ %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06")  ~ "Acute upper respiratory infections",
      icdcode_first_two %in% c("09", "10", "11", "12", "13", "14", "15", "16", "17", "18") ~ "Influenza and pneumonia",
      icdcode_first_two %in% as.character(20:22) ~ "Other acute lower respiratory infections",
      icdcode_first_two %in% as.character(30:39) ~ "Other diseases of upper respiratory tract",
      icdcode_first_two %in% c("40", "41", "42", "43", "44", "45", "46", "47", "48", "4A") ~ "Chronic lower respiratory diseases",
      icdcode_first_two %in% as.character(60:70) ~ "Lung diseases due to external agents",
      icdcode_first_two %in% as.character(80:84) ~ "Other respiratory diseases principally affecting the interstitium",
      icdcode_first_two %in% as.character(85:86) ~ "Suppurative and necrotic conditions of the lower respiratory tract",
      icdcode_first_two %in% as.character(90:94) ~ "Other diseases of the pleura",
      icdcode_first_two %in% c("95") ~ "Intraoperative and postprocedural complications and disorders of respiratory system, not elsewhere classified",
      icdcode_first_two %in% as.character(96:99) ~ "Other diseases of the respiratory system",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
    )
)

write.csv(dfJ, file = "/intermediate/dfJ.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfJ %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfJ <- dfJ %>%
  filter(disease_category %in% category_counts_filtered$disease_category)

```

```{r}
# Loop through each disease category in the filtered category_counts
resultsJ <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfJ %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsJ, file = "/results_felm_linear/resultsJ.csv", row.names = FALSE)
```


#ICD K
```{r}
datasetsK <- df_combined %>% 
  filter(ICDcategory == "k")

dfK <- datasetsK %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09","10","11","12", "13", "14") ~ "Diseases of oral cavity and salivary glands",
      icdcode_first_two %in% as.character(20:31) ~ "Diseases of esophagus, stomach and duodenum",
      icdcode_first_two %in% as.character(35:38) ~ "Diseases of appendix",
      icdcode_first_two %in% as.character(40:46) ~ "Hernia",
      icdcode_first_two %in% as.character(50:52) ~ "Noninfective enteritis and colitis",
      icdcode_first_two %in% as.character(55:64) ~ "Other diseases of intestines",
      icdcode_first_two %in% as.character(65:68) ~ "Diseases of peritoneum and retroperitoneum",
      icdcode_first_two %in% as.character(70:77) ~ "Diseases of liver",
      icdcode_first_two %in% as.character(80:87) ~ "Disorders of gallbladder, biliary tract and pancreas",
      icdcode_first_two %in% as.character(90:95) ~ "Other diseases of the digestive system",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfK, file = "/intermediate/dfK.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfK %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfK <- dfK %>%
  filter(disease_category %in% category_counts_filtered$disease_category)

```

```{r}
# Loop through each disease category in the filtered category_counts
resultsK <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfK %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsK, file = "/results_felm_linear/resultsK.csv", row.names = FALSE)
```


#ICD L
```{r}
datasetsL <- df_combined %>% 
  filter(ICDcategory == "l")

dfL <- datasetsL %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08") ~ "Infections of the skin and subcutaneous tissue",
      icdcode_first_two %in% c("10", "11", "12", "13", "14") ~ "Bullous disorders",
      icdcode_first_two %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30") ~ "Dermatitis and eczema",
      icdcode_first_two %in% c("40", "41", "42", "43", "44", "45") ~ "Papulosquamous disorders",
      icdcode_first_two %in% c("49", "50", "51", "52", "53", "54") ~ "Urticaria and erythema",
      icdcode_first_two %in% c("55", "56", "57", "58", "59") ~ "Radiation-related disorders of the skin and subcutaneous tissue",
      icdcode_first_two %in% c("60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75") ~ "Disorders of skin appendages",
      icdcode_first_two %in% c("76", "77", "78", "79", "80", "81", "82", "83", "84", "85", "86", "87", "88", "89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99") ~ "Other disorders of the skin and subcutaneous tissue",
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfL, file = "/intermediate/dfL.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfL %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfL <- dfL %>%
  filter(disease_category %in% category_counts_filtered$disease_category)

```

```{r}
# Loop through each disease category in the filtered category_counts
resultsL <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfL %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsL, file = "/results_felm_linear/resultsL.csv", row.names = FALSE)
```


#ICD M
```{r}
datasetsM <- df_combined %>% 
  filter(ICDcategory == "m")

dfM <- datasetsM %>%
  mutate(
    disease_category = case_when(
        icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25") ~ "Arthropathies",
      icdcode_first_two %in% as.character(26:27) ~ "Dentofacial anomalies [including malocclusion] and other disorders of jaw",
      icdcode_first_two %in% as.character(30:36) ~ "Systemic connective tissue disorders",
      icdcode_first_two %in% as.character(40:54) ~ "Dorsopathies",
      icdcode_first_two %in% as.character(60:79) ~ "Soft tissue disorders",
      icdcode_first_two %in% as.character(80:94) ~ "Osteopathies and chondropathies",
      icdcode_first_two %in% c("95") ~ "Other disorders of the musculoskeletal system and connective tissue",
      icdcode_first_two %in% c("96") ~ "Intraoperative and postprocedural complications and disorders of musculoskeletal system, not elsewhere classified",
      icdcode_first_two %in% c("97") ~ "Periprosthetic fracture around internal prosthetic joint",
      icdcode_first_two %in% c("99") ~ "Biomechanical lesions, not elsewhere classified",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfM, file = "/intermediate/dfM.csv", row.names = FALSE)
```

```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfM %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfM %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfM <- dfM %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsM <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfM %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsM, file = "/results_felm_linear/resultsM.csv", row.names = FALSE)
```

#ICD N
```{r}
datasetsN <- df_combined %>% 
  filter(ICDcategory == "n")

dfN <- datasetsN %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08") ~ "Glomerular diseases",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15", "16") ~ "Renal tubulo-interstitial diseases",
      icdcode_first_two %in% c("17", "18", "19") ~ "Acute kidney failure and chronic kidney disease",
      icdcode_first_two %in% c("20", "21", "22", "23") ~ "Urolithiasis",
      icdcode_first_two %in% c("25", "26", "27", "28", "29") ~ "Other disorders of kidney and ureter",
      icdcode_first_two %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39") ~ "Other diseases of the urinary system",
      icdcode_first_two %in% c("40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53") ~ "Diseases of male genital organs",
      icdcode_first_two %in% c("60", "61", "62", "63", "64", "65") ~ "Disorders of breast",
      icdcode_first_two %in% c("70", "71", "72", "73", "74", "75", "76", "77") ~ "Inflammatory diseases of female pelvic organs",
      icdcode_first_two %in% c("80", "81", "82", "83", "84", "85", "86", "87", "88", "89", "90", "91", "92", "93", "94", "95", "96", "97", "98") ~ "Noninflammatory disorders of female genital tract",
      icdcode_first_two %in% c("99") ~ "Intraoperative and postprocedural complications and disorders of genitourinary system, not elsewhere classified",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfN, file = "/intermediate/dfN.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfN %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfN <- dfN %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsN <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfN %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsN, file = "/results_felm_linear/resultsN.csv", row.names = FALSE)
```


#ICD O
```{r}
datasetsO <- df_combined %>% 
  filter(ICDcategory == "o")

dfO <- datasetsO %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08") ~ "Pregnancy with abortive outcome",
      icdcode_first_two %in% c("09") ~ "Supervision of high risk pregnancy",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15", "16") ~ "Edema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium",
      icdcode_first_two %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28", "29") ~ "Other maternal disorders predominantly related to pregnancy",
      icdcode_first_two %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48") ~ "Maternal care related to the fetus and amniotic cavity and possible delivery problems",
      icdcode_first_two %in% c("60", "61", "62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "77") ~ "Complications of labor and delivery",
      icdcode_first_two %in% c("80", "81", "82", "83", "84") ~ "Encounter for delivery",
      icdcode_first_two %in% c("85", "86", "87", "88", "89", "90", "91", "92") ~ "Complications predominantly related to the puerperium",
      icdcode_first_two %in% c("94", "95", "96", "97", "98", "99", "9A") ~ "Other obstetric conditions, not elsewhere classified",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfO, file = "/intermediate/dfO.csv", row.names = FALSE)
```


#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfO %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfO <- dfO %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```


```{r}
# Loop through each disease category in the filtered category_counts
resultsO <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfO %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsO, file = "/results_felm_linear/resultsO.csv", row.names = FALSE)
```


#ICD P
```{r}
datasetsP <- df_combined %>% 
  filter(ICDcategory == "p")

dfP <- datasetsP %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04") ~ "Newborn affected by maternal factors and by complications of pregnancy, labor, and delivery",
      icdcode_first_two %in% c("05", "06", "07", "08") ~ "Disorders of newborn related to length of gestation and fetal growth",
      icdcode_first_two %in% c("09") ~ "Abnormal findings on neonatal screening",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15") ~ "Birth trauma",
      icdcode_first_two %in% c("19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29") ~ "Respiratory and cardiovascular disorders specific to the perinatal period",
      icdcode_first_two %in% c("35", "36", "37", "38", "39") ~ "Infections specific to the perinatal period",
      icdcode_first_two %in% c("50", "51", "52", "53", "54", "55", "56", "57", "58", "59", "60", "61") ~ "Hemorrhagic and hematological disorders of newborn",
      icdcode_first_two %in% c("70", "71", "72", "73", "74") ~ "Transitory endocrine and metabolic disorders specific to newborn",
      icdcode_first_two %in% c("76", "77", "78") ~ "Digestive system disorders of newborn",
      icdcode_first_two %in% c("80", "81", "82", "83") ~ "Conditions involving the integument and temperature regulation of newborn",
      icdcode_first_two %in% c("84") ~ "Other problems with newborn",
      icdcode_first_two %in% c("90", "91", "92", "93", "94", "95", "96") ~ "Other disorders originating in the perinatal period",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfP, file = "/intermediate/dfP.csv", row.names = FALSE)
```


#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfP %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfP <- dfP %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```


```{r}
# Loop through each disease category in the filtered category_counts
resultsP <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfP %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsP, file = "/results_felm_linear/resultsP.csv", row.names = FALSE)
```


#ICD Q
```{r}
datasetsQ <- df_combined %>% 
  filter(ICDcategory == "q")

dfQ <- datasetsQ %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07") ~ "Congenital malformations of the nervous system",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15", "16", "17", "18") ~ "Congenital malformations of eye, ear, face and neck",
      icdcode_first_two %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28") ~ "Congenital malformations of the circulatory system",
      icdcode_first_two %in% c("30", "31", "32", "33", "34") ~ "Congenital malformations of the respiratory system",
      icdcode_first_two %in% c("35", "36", "37") ~ "Cleft lip and cleft palate",
      icdcode_first_two %in% c("38", "39", "40", "41", "42", "43", "44", "45") ~ "Other congenital malformations of the digestive system",
      icdcode_first_two %in% c("50", "51", "52", "53", "54", "55", "56") ~ "Congenital malformations of genital organs",
      icdcode_first_two %in% c("60", "61", "62", "63", "64") ~ "Congenital malformations of the urinary system",
      icdcode_first_two %in% c("65", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "77", "78", "79") ~ "Congenital malformations and deformations of the musculoskeletal system",
      icdcode_first_two %in% c("80", "81", "82", "83", "84", "85", "86", "87", "88", "89") ~ "Other congenital malformations",
      icdcode_first_two %in% c("90", "91", "92", "93", "94", "95", "96", "97", "98", "99") ~ "Chromosomal abnormalities, not elsewhere classified",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfQ, file = "/intermediate/dfQ.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfQ %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfQ <- dfQ %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsQ <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfQ %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsQ, file = "/results_felm_linear/resultsQ.csv", row.names = FALSE)
```


#ICD R
```{r}
datasetsR <- df_combined %>% 
  filter(ICDcategory == "r")

dfR <- datasetsR %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "Symptoms and signs involving the circulatory and respiratory systems",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15", "16", "17", "18", "19") ~ "Symptoms and signs involving the digestive system and abdomen",
      icdcode_first_two %in% c("20", "21", "22", "23") ~ "Symptoms and signs involving the skin and subcutaneous tissue",
      icdcode_first_two %in% c("25", "26", "27", "28", "29") ~ "Symptoms and signs involving the nervous and musculoskeletal systems",
      icdcode_first_two %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39") ~ "Symptoms and signs involving the genitourinary system",
      icdcode_first_two %in% c("40", "41", "42", "43", "44", "45", "46") ~ "Symptoms and signs involving cognition, perception, emotional state and behavior",
      icdcode_first_two %in% c("47", "48", "49") ~ "Symptoms and signs involving speech and voice",
      icdcode_first_two %in% c("50", "51", "52", "53", "54", "55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65","66","67", "68","69") ~ "General symptoms and signs",
      icdcode_first_two %in% c("70", "71", "72", "73", "74", "75", "76", "77", "78", "79") ~ "Abnormal findings on examination of blood, without diagnosis",
      icdcode_first_two %in% c("80", "81", "82") ~ "Abnormal findings on examination of urine, without diagnosis",
      icdcode_first_two %in% c("83", "84", "85", "86", "87", "88", "89") ~ "Abnormal findings on examination of other body fluids, substances and tissues, without diagnosis",
      icdcode_first_two %in% c("90", "91", "92", "93", "94") ~ "Abnormal findings on diagnostic imaging and in function studies, without diagnosis",
      icdcode_first_two %in% c("97") ~ "Abnormal tumor markers",
      icdcode_first_two %in% c("99") ~ "Ill-defined and unknown cause of mortality",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfR, file = "/intermediate/dfR.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfR %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfR <- dfR %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsR <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfR %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsR, file = "/results_felm_linear/resultsR.csv", row.names = FALSE)
```


#ICD S
```{r}
datasetsS <- df_combined %>% 
  filter(ICDcategory == "s")

dfS <- datasetsS %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "Injuries to the head",
      icdcode_first_two %in% c("10", "11", "12", "13", "14", "15", "16", "17", "18", "19") ~ "Injuries to the neck",
      icdcode_first_two %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28", "29") ~ "Injuries to the thorax",
      icdcode_first_two %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39") ~ "Injuries to the abdomen, lower back, lumbar spine, pelvis and external genitals",
      icdcode_first_two %in% c("40", "41", "42", "43", "44", "45", "46", "47", "48", "49") ~ "Injuries to the shoulder and upper arm",
      icdcode_first_two %in% c("50", "51", "52", "53", "54", "55", "56", "57", "58", "59") ~ "Injuries to the elbow and forearm",
      icdcode_first_two %in% c("60", "61", "62", "63", "64", "65", "66", "67", "68", "69") ~ "Injuries to the wrist, hand and fingers",
      icdcode_first_two %in% c("70", "71", "72", "73", "74", "75", "76", "77", "78", "79") ~ "Injuries to the hip and thigh",
      icdcode_first_two %in% c("80", "81", "82", "83", "84", "85", "86", "87", "88", "89") ~ "Injuries to the knee and lower leg",
      icdcode_first_two %in% c("90", "91", "92", "93", "94", "95", "96", "97", "98", "99") ~ "Injuries to the ankle and foot",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)

)

write.csv(dfS, file = "/intermediate/dfS.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfS %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfS <- dfS %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsS <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfS %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsS, file = "/results_felm_linear/resultsS.csv", row.names = FALSE)
```


#ICD T
```{r}
datasetsT <- df_combined %>% 
  filter(ICDcategory == "t")

dfT <- datasetsT %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07") ~ "Injuries involving multiple body regions",
      icdcode_first_two %in% c("08", "09", "10", "11", "12", "13", "14") ~ "Injuries to unspecified part of trunk, limb or body region",
      icdcode_first_two %in% c("15", "16", "17", "18", "19") ~ "Effects of foreign body entering through natural orifice",
      icdcode_first_two %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32") ~ "Burns and corrosions",
      icdcode_first_two %in% c("33", "34", "35") ~ "Frostbite",
      icdcode_first_two %in% c("36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50") ~ "Poisoning by drugs, medicaments and biological substances",
      icdcode_first_two %in% c("51", "52", "53", "54", "55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65") ~ "Toxic effects of substances chiefly nonmedicinal as to source",
      icdcode_first_two %in% c("66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "77", "78") ~ "Other and unspecified effects of external causes",
      icdcode_first_two %in% c("79") ~ "Certain early complications of trauma",
      icdcode_first_two %in% c("80", "81", "82", "83", "84", "85", "86", "87", "88") ~ "Complications of surgical and medical care, not elsewhere classified",
      icdcode_first_two %in% c("90", "91", "92", "93", "94", "95", "96", "97", "98") ~ "Sequelae of injuries, of poisoning and of other consequences of external causes",
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfT, file = "/intermediate/dfT.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfT %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfT <- dfT %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsT <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfT %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsT, file = "/results_felm_linear/resultsT.csv", row.names = FALSE)
```


#ICD U
```{r}
datasetsU <- df_combined %>% 
  filter(ICDcategory == "u")

dfU <- datasetsU %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49") ~ "Provisional assignment of new diseases of uncertain etiology or emergency use",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfU, file = "/intermediate/dfU.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfU %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfU <- dfU %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsU <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfU %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsU, file = "/results_felm_linear/resultsU.csv", row.names = FALSE)
```


#ICD V
```{r}
datasetsV <- df_combined %>% 
  filter(ICDcategory == "v")

dfV <- datasetsV %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44", "45", "46", "47", "48", "49") ~ "Provisional assignment of new diseases of uncertain etiology or emergency use",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfV, file = "/intermediate/dfV.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfV %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfV <- dfV %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsV <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfV %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsV, file = "/results_felm_linear/resultsV.csv", row.names = FALSE)
```



#ICD X
```{r}
datasetsX <- df_combined %>% 
  filter(ICDcategory == "x")

dfX <- datasetsX %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("71", "72", "73", "74", "75", "76", "77", "78", "79", "80", "81", "82", "83") ~ "Intentional self-harm",
      icdcode_first_two %in% c("92", "93", "94", "95", "96", "97", "98", "99", "00", "01", "02", "03", "04", "05", "06", "07", "08", "09") ~ "Assault",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfX, file = "/intermediate/dfX.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfX %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfX <- dfX %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsX <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfX %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsX, file = "/results_felm_linear/resultsX.csv", row.names = FALSE)
```


#ICD Y
```{r}
datasetsY <- df_combined %>% 
  filter(ICDcategory == "y")

dfY <- datasetsY %>%
  mutate(
    disease_category = case_when(
      icdcode_first_two %in% c("21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31", "32", "33") ~ "Event of undetermined intent",
      icdcode_first_two %in% c("35", "36", "37", "38") ~ "Legal intervention, operations of war, military operations, and terrorism",
      icdcode_first_two %in% c("62", "63", "64", "65", "66", "67", "68", "69", "70", "71", "72", "73", "74", "75", "76", "77", "78", "79", "80", "81", "82", "83", "84") ~ "Complications of medical and surgical care",
      icdcode_first_two %in% c("90", "91", "92", "93", "94", "95", "96", "97", "98", "99") ~ "Supplementary factors related to causes of morbidity classified elsewhere",
  
      TRUE ~ "Other"  # If none of the categories match, assign "Other"
)
)

write.csv(dfY, file = "/intermediate/dfY.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfY %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfY <- dfY %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsY <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfY %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsY, file = "/results_felm_linear/resultsY.csv", row.names = FALSE)
```

#ICD Z
```{r}
datasetsZ <- df_combined %>% 
  filter(ICDcategory == "z")

dfZ <- datasetsZ %>%
  mutate(
    disease_category = case_when(
  icdcode_first_two %in% c("00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13") ~ "Persons encountering health services for examination and investigation",
  icdcode_first_two %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28", "29") ~ "Persons with potential health hazards related to communicable diseases",
  icdcode_first_two %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39") ~ "Persons encountering health services in circumstances related to reproduction",
  icdcode_first_two %in% c("40", "41", "42", "43", "44", "45", "46", "47", "48", "49", "50", "51", "52", "53") ~ "Persons encountering health services for specific procedures and health care",
  icdcode_first_two %in% c("55", "56", "57", "58", "59", "60", "61", "62", "63", "64", "65") ~ "Persons with potential health hazards related to socioeconomic and psychosocial circumstances",
  icdcode_first_two %in% c("70", "71", "72", "73", "74", "75", "76") ~ "Persons encountering health services in other circumstances",
  icdcode_first_two %in% c("80", "81", "82", "83", "84", "85", "86", "87", "88", "89", "90", "91", "92", "93", "94", "95", "96", "97", "98", "99") ~ "Persons with potential health hazards related to family and personal history and certain conditions influencing health status",
  
  TRUE ~ "Other"  # If none of the categories match, assign "Other"
)

)

write.csv(dfZ, file = "/intermediate/dfZ.csv", row.names = FALSE)
```

#get the counts per disease category, remove disease areas with less than 10,000, run the model
```{r}
# Summarize the number of occurrences in each disease category
category_counts <- dfZ %>%
  group_by(disease_category) %>%
  summarize(count = n())  # Count occurrences of each disease category

category_counts_filtered <- category_counts %>%
  filter(count >= 10000)

dfZ <- dfZ %>%
  filter(disease_category %in% category_counts_filtered$disease_category)
```

```{r}
# Loop through each disease category in the filtered category_counts
resultsZ <- category_counts_filtered$disease_category %>%
  purrr::map_df(~{
    # Filter dfA_filtered for the current disease category
    df_category <- dfZ %>% filter(disease_category == .x)
    
    total_count <- category_counts_filtered %>% 
      filter(disease_category == .x) %>% 
      select(count) %>% 
      unlist()
    
    # Run the model on the filtered data for this disease category
    model <- felm(log_cases ~ temp + precip | state + month + year | 0 | state, data = df_category)
    
    # Get the summary of the model
    model_summary <- summary(model)
    
    # Extract the temp coefficient and p-value
    temp_coef <- model_summary$coefficients["temp", "Estimate"]
    temp_pval <- model_summary$coefficients["temp", "Pr(>|t|)"]
    
    # Extract the precip coefficient and p-value
    precip_coef <- model_summary$coefficients["precip", "Estimate"]
    precip_pval <- model_summary$coefficients["precip", "Pr(>|t|)"]
    
    # Return a tibble with the results
    tibble(
      disease_category = .x,
      temp_coef = temp_coef,
      temp_pval = temp_pval,
      precip_coef = precip_coef,
      precip_pval = precip_pval,
      total_count = total_count
    )
  })

write.csv(resultsZ, file = "/results_felm_linear/resultsZ.csv", row.names = FALSE)
```



Combine all of the results of the linear fixed effect regression models into one dataset
#combine together
```{r}
# List of dataset names in lowercase
dataset_list <- list(resultsA, resultsB, resultsC, resultsD, resultsE, resultsF, resultsG, resultsH, 
                     resultsI, resultsJ, resultsK, resultsL, resultsM, resultsN, resultsO, resultsP, 
                     resultsQ, resultsR, resultsS, resultsT, resultsZ)

# Add a column "ICD_code" to each dataset and assign the appropriate letter
for (i in seq_along(dataset_list)) {
  # Check if the dataset is resultsZ and assign "z"
  if (i == length(dataset_list)) {  # Check if it's the last dataset, resultsZ
    dataset_list[[i]]$ICD_code <- "z"
  } else {
    dataset_list[[i]]$ICD_code <- letters[i]  # Assigning "a", "b", ..., "z"
  }
}

# Combine all datasets into one
combined_results <- do.call(rbind, dataset_list)
```

#save
```{r}
write.csv(combined_results, file = "/results_felm_linear/combined.csv", row.names = FALSE)
```

```{r}
combined_results <- read.csv("/results_felm_linear/combined.csv")
```


#plot the results of the models across all disease areas
```{r}
ggplot(combined_results, aes(x = temp_pval)) +
  geom_density(color = "blue", fill = "blue", alpha = 0.5, adjust = 1.5) +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "black", size = 0.5) + 
  scale_x_continuous(breaks = c(0, 0.05, 1), labels = c("0", "0.05", "1")) +
  labs(title = "Significance of Temperature and Hospitalization Relationship", x = "P-Value", y = "Density") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman"), 
    axis.title = element_text(size = 16),  
    axis.text = element_text(size = 14),  
    plot.title = element_text(size = 18, hjust = 0.5), 
    plot.margin = margin(10, 10, 10, 10)
  )
```

#test cutoffs sizes for total number of cases for a specific disease area
```{r}
combined_results_filtered <- combined_results %>%
  filter (total_count >= 50000)

combined_results_filtered2 <- combined_results %>%
  filter (total_count >= 75000)

combined_results_filtered3 <- combined_results %>%
  filter (total_count >= 100000)
```

```{r}
ggplot(combined_results_filtered, aes(x = temp_pval)) +
  geom_density(color = "blue", fill = "blue", alpha = 0.5, adjust = 1.5) +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "black", size = 0.5) +
  scale_x_continuous(breaks = c(0, 0.05, 1), labels = c("0", "0.05", "1")) +
  labs(title = "Significance of Temperature and Hospitalization Relationship", x = "P-Value", y = "Density") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman"),  
    axis.title = element_text(size = 16),  
    axis.text = element_text(size = 14),   
    plot.title = element_text(size = 18, hjust = 0.5), 
    plot.margin = margin(10, 10, 10, 10)   
  )

ggplot(combined_results_filtered2, aes(x = temp_pval)) +
  geom_density(color = "blue", fill = "blue", alpha = 0.5, adjust = 1.5) +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "black", size = 0.5) +
  scale_x_continuous(breaks = c(0, 0.05, 1), labels = c("0", "0.05", "1")) +
  labs(title = "Significance of Temperature and Hospitalization Relationship", x = "P-Value", y = "Density") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman"),  
    axis.title = element_text(size = 16),  
    axis.text = element_text(size = 14),   
    plot.title = element_text(size = 18, hjust = 0.5), 
    plot.margin = margin(10, 10, 10, 10)   
  )

ggplot(combined_results_filtered3, aes(x = temp_pval)) +
  geom_density(color = "blue", fill = "blue", alpha = 0.5, adjust = 1.5) +
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "black", size = 0.5) +
  scale_x_continuous(breaks = c(0, 0.05, 1), labels = c("0", "0.05", "1")) +
  labs(title = "Significance of Temperature and Hospitalization Relationship", x = "P-Value", y = "Density") +
  theme_minimal() +
  theme(
    text = element_text(family = "Times New Roman"),  
    axis.title = element_text(size = 16),  
    axis.text = element_text(size = 14),   
    plot.title = element_text(size = 18, hjust = 0.5), 
    plot.margin = margin(10, 10, 10, 10)   
  )
```

#use 50,000 cases as a threshold
```{r}
combined_results_filtered <- combined_results %>%
  filter (total_count >= 50000)
```

#create columns for adjusted p-values
```{r}
num_tests <- nrow(combined_results_filtered)

# Create the new columns
combined_results_filtered <- combined_results_filtered %>%
  mutate(
    bonferroni_temp_pval = p.adjust(temp_pval, method = "bonferroni"), 
    fdr_temp_pval = p.adjust(temp_pval, method = "fdr")
  )
```

#round to 5 decimal places
```{r}
combined_results_filtered <- combined_results_filtered %>%
  mutate(across(c(temp_coef, temp_pval, precip_coef, precip_pval, bonferroni_temp_pval, fdr_temp_pval), ~ round(.x, 5)))
```

#set order
```{r}
combined_results_filtered <- combined_results_filtered %>%
  dplyr::select(ICD_code, disease_category, total_count, temp_coef, temp_pval, bonferroni_temp_pval, fdr_temp_pval, precip_coef, precip_pval) %>%
  dplyr::arrange(temp_pval)
```

#write and save the resutls
```{r}
write.csv(combined_results_filtered, file = "/results_felm_linear/combined_clean.csv", row.names = FALSE)
```



#plot the results adjusted and unadjusted 
```{r}
ggplot(combined_results_filtered, aes(x = temp_pval)) +
  geom_histogram(
    breaks = seq(0, 1, by = 0.05), 
    fill = "steelblue", 
    color = "black", 
    alpha = 0.5
  ) + 
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "black", size = 0.5) +
  geom_vline(xintercept = 0.10, linetype = "dashed", color = "black", size = 0.5) +
  scale_x_continuous(breaks = c(0, 0.05, 0.1, 0.5,1), labels = c("0",".05", ".1",".5", "1")) +
  labs(title = "Evaluating the Significance of Temperature on\nHospitalization Rates Across Disease Areas", x = "P-Value", y = "Count") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),  
    panel.grid.minor = element_blank(), 
    text = element_text(family = "Arial"),  
    axis.title = element_text(size = 16),  
    axis.text = element_text(size = 14),   
    plot.title = element_text(size = 24, hjust = 0.5), 
    plot.margin = margin(10, 10, 10, 10),   
    panel.grid.major.x = element_blank()  
  )

ggplot(combined_results_filtered, aes(x = fdr_temp_pval)) +
  geom_histogram(
    breaks = seq(0, 1, by = 0.05), 
    fill = "steelblue", 
    color = "black", 
    alpha = 0.5
  ) + 
  geom_vline(xintercept = 0.05, linetype = "dashed", color = "black", size = 0.5) +
  geom_vline(xintercept = 0.10, linetype = "dashed", color = "black", size = 0.5) +
  scale_x_continuous(breaks = c(0, 0.05, 0.1, 0.5,1), labels = c("0",".05", ".1",".5", "1")) +
  labs(title = "Evaluating the Significance of Temperature on\nHospitalization Rates Across Disease Areas", x = "FDR Adjusted P-Value", y = "Count") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),  
    text = element_text(family = "Arial"),  
    axis.title = element_text(size = 16),  
    axis.text = element_text(size = 14),   
    plot.title = element_text(size = 24, hjust = 0.5), 
    plot.margin = margin(10, 10, 10, 10)   
  )

```






